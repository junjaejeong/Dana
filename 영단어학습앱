import streamlit as st
import gspread
from oauth2client.service_account import ServiceAccountCredentials
from datetime import datetime
import random
import pandas as pd

# â”€â”€â”€ 1) Google Sheets ì¸ì¦ & ì‹œíŠ¸ ì—°ê²° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
scope = ["https://spreadsheets.google.com/feeds","https://www.googleapis.com/auth/drive"]
creds = ServiceAccountCredentials.from_json_keyfile_name(
    "C:/Users/Triple J/Desktop/ë‹¤ì†œ/ì˜ë‹¨ì–´/youtube-tutor-search-90112becbd81.json", scope
)
client = gspread.authorize(creds)
sheet = client.open_by_url(
    "https://docs.google.com/spreadsheets/d/1LeJbpsS1eOzf2ZT8qIWhzYOf3hrdqefyoV3Qf9o2EgQ/edit"
).sheet1

# â”€â”€â”€ 2) í˜ì´ì§€ ì„¤ì • & ëª¨ë“œ ì„ íƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
st.set_page_config(page_title="ì˜ë‹¨ì–´ í•™ìŠµ ì•±", layout="wide")
mode = st.sidebar.radio("ğŸ”€ ëª¨ë“œ ì„ íƒ", ["ë‹¨ì–´ ë“±ë¡", "í€´ì¦ˆ ì‹œì‘"], index=1)

# â”€â”€â”€ 3) ëª¨ë“œ ì „í™˜ ì‹œ ì„¸ì…˜ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "last_mode" not in st.session_state:
    st.session_state.last_mode = None
if st.session_state.last_mode != mode:
    for k in ["quiz_started","quiz_index","quiz_data","quiz_type",
              "all_answers","answered","retry","row_count"]:
        st.session_state.pop(k, None)
    st.session_state.last_mode = mode

# â”€â”€â”€ 4) ë‹¨ì–´ ë“±ë¡ ëª¨ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if mode == "ë‹¨ì–´ ë“±ë¡":
    if "row_count" not in st.session_state:
        st.session_state.row_count = 10

    st.header("ğŸ“¥ ë‹¨ì–´ ë“±ë¡")
    st.write("ì˜ì–´ ë‹¨ì–´ì™€ í•œêµ­ì–´ ëœ»ì„ ì…ë ¥í•˜ì„¸ìš”. (ìµœì´ˆ 10ê°œ í•„ë“œ)")

    inputs = []
    for i in range(st.session_state.row_count):
        c1, c2 = st.columns(2)
        with c1:
            eng = st.text_input(f"{i+1}. ì˜ì–´ ë‹¨ì–´", key=f"eng_{i}")
        with c2:
            kor = st.text_input(f"{i+1}. í•œêµ­ì–´ ëœ»", key=f"kor_{i}")
        inputs.append((eng, kor))

    ca, cs = st.columns(2)
    with ca:
        if st.button("â• í•œ ì¤„ ì¶”ê°€"):
            st.session_state.row_count += 1
            st.rerun()
    with cs:
        if st.button("ğŸ’¾ ì €ì¥í•˜ê¸°"):
            today = datetime.now().strftime("%Y-%m-%d")
            cnt = 0
            for eng, kor in inputs:
                if eng and kor:
                    sheet.append_row([eng.strip(), kor.strip(), today])
                    cnt += 1
            st.success(f"âœ… {cnt}ê°œ ë‹¨ì–´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")
    st.stop()

# â”€â”€â”€ 5) í€´ì¦ˆ ëª¨ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
data = sheet.get_all_records()
st.header("Dana's ì˜ì–´ ë‹¨ì–´ í€´ì¦ˆ")

# â”€â”€â”€ 5.1) ì„¸ì…˜ ì´ˆê¸°í™” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if "quiz_started" not in st.session_state:
    st.session_state.update({
        "quiz_started": False,
        "quiz_index":   0,
        "quiz_data":    [],
        "quiz_type":    "ê°ê´€ì‹",
        "all_answers":  [],
        "answered":     False,
        "retry":        False,
    })

# â”€â”€â”€ 5.2) í€´ì¦ˆ ì‹œì‘ í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if not st.session_state.quiz_started:
    st.write("#### ê¸°ê°„ê³¼ ë¬¸ì œ ìœ í˜•ì„ ì„ íƒí•˜ê³  â–¶ï¸ ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”")
    
    # ê¸°ê°„ ì„ íƒ ë°©ì‹ ë¼ë””ì˜¤ ë²„íŠ¼
    date_mode = st.radio("ğŸ“… ê¸°ê°„ ì„ íƒ ë°©ì‹", ["íŠ¹ì • ë‚ ì§œ", "ê¸°ê°„ ë²”ìœ„"])
    
    if date_mode == "íŠ¹ì • ë‚ ì§œ":
        sel_date = st.date_input("ë‚ ì§œ ì„ íƒ")
        start_date = end_date = sel_date
    else:
        # ê¸°ê°„ ë²”ìœ„ ì„ íƒ
        date_range = st.date_input(
            "ê¸°ê°„ ë²”ìœ„ ì„ íƒ",
            value=(),
            help="ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ìˆœì„œëŒ€ë¡œ ì„ íƒí•˜ì„¸ìš”"
        )
        
        if len(date_range) == 2:
            start_date, end_date = date_range
        elif len(date_range) == 1:
            start_date = end_date = date_range[0]
            st.info("ì¢…ë£Œ ë‚ ì§œë„ ì„ íƒí•´ì£¼ì„¸ìš”")
        else:
            st.warning("ì‹œì‘ ë‚ ì§œì™€ ì¢…ë£Œ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”")
            start_date = end_date = None
    
    qtype = st.radio("ë¬¸ì œ ìœ í˜•", ["ê°ê´€ì‹","ì£¼ê´€ì‹","í˜¼í•©"])
    
    if st.button("â–¶ï¸ ì‹œì‘"):
        if date_mode == "ê¸°ê°„ ë²”ìœ„" and (start_date is None or end_date is None):
            st.warning("âŒ ê¸°ê°„ì„ ì˜¬ë°”ë¥´ê²Œ ì„ íƒí•´ì£¼ì„¸ìš”.")
        else:
            # ì„ íƒëœ ê¸°ê°„ ë²”ìœ„ ë‚´ì˜ ë‹¨ì–´ë“¤ í•„í„°ë§
            rows = []
            for r in data:
                upload_date_str = r.get("ì—…ë¡œë“œë‚ ì§œ", "").strip()
                if upload_date_str:
                    try:
                        upload_date = datetime.strptime(upload_date_str, "%Y-%m-%d").date()
                        if start_date <= upload_date <= end_date:
                            rows.append(r)
                    except ValueError:
                        continue  # ë‚ ì§œ í˜•ì‹ì´ ì˜ëª»ëœ ê²½ìš° ìŠ¤í‚µ
            
            if not rows:
                if date_mode == "íŠ¹ì • ë‚ ì§œ":
                    st.warning(f"âŒ {start_date.strftime('%Y-%m-%d')}ì— ë“±ë¡ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.")
                else:
                    st.warning(f"âŒ {start_date.strftime('%Y-%m-%d')} ~ {end_date.strftime('%Y-%m-%d')} ê¸°ê°„ì— ë“±ë¡ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.")
            else:
                st.session_state.quiz_data    = random.sample(rows, min(20, len(rows)))
                st.session_state.quiz_type    = qtype
                st.session_state.quiz_started = True
                st.session_state.quiz_index   = 0
                st.session_state.all_answers  = []
                st.session_state.answered     = False
                st.session_state.retry        = False
                st.rerun()  # st.stop() ëŒ€ì‹  st.rerun() ì‚¬ìš©
    st.stop()

# â”€â”€â”€ 5.3) í€´ì¦ˆ ì¢…ë£Œ ë° ìš”ì•½ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if st.session_state.quiz_index >= len(st.session_state.quiz_data):
    total   = len(st.session_state.all_answers)
    correct = sum(a["is_correct"] for a in st.session_state.all_answers)
    st.markdown("#### ğŸ‰ í€´ì¦ˆ ì™„ë£Œ!")
    st.write(f"**ì´ {total}ë¬¸ì œ ì¤‘ {correct}ë¬¸ì œ ë§ì•˜ìŠµë‹ˆë‹¤!**")
    df = pd.DataFrame(st.session_state.all_answers)
    st.dataframe(
        df.rename(columns={
            "word":"ì˜ë‹¨ì–´","meaning":"ëœ»",
            "user_ans":"ë‚´ ë‹µì•ˆ","correct_ans":"ì •ë‹µ",
            "is_correct":"ì •ë‹µì—¬ë¶€"
        }),
        use_container_width=True
    )
    if not st.session_state.retry and correct < total:
        if st.button("ğŸ”„ ì˜¤ë‹µ ë‹¤ì‹œ í’€ê¸°"):
            wrong = [a for a in st.session_state.all_answers if not a["is_correct"]]
            st.session_state.quiz_data   = [
                {"ì˜ë‹¨ì–´":w["word"], "ëœ»":w["meaning"]} for w in wrong
            ]
            st.session_state.quiz_index  = 0
            st.session_state.all_answers = []
            st.session_state.answered    = False
            st.session_state.retry       = True
            st.rerun()
    st.stop()

# â”€â”€â”€ 5.4) ë¬¸ì œ í™”ë©´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
q = st.session_state.quiz_data[st.session_state.quiz_index]
st.write(f"#### ë¬¸ì œ {st.session_state.quiz_index+1} / {len(st.session_state.quiz_data)}")

# í˜¼í•© ëª¨ë“œì—ì„œ ê° ë¬¸ì œì˜ ìœ í˜•ì„ ì„¸ì…˜ì— ì €ì¥
q_type = st.session_state.quiz_type
if q_type == "í˜¼í•©":
    # ê° ë¬¸ì œì˜ ìœ í˜•ì„ ì„¸ì…˜ì— í•œ ë²ˆë§Œ ì €ì¥
    type_key = f"qtype_{st.session_state.quiz_index}"
    if type_key not in st.session_state:
        st.session_state[type_key] = random.choice(["ê°ê´€ì‹","ì£¼ê´€ì‹"])
    q_type = st.session_state[type_key]

# â”€â”€â”€ 5.4.1) ê°ê´€ì‹ ë¬¸ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if q_type == "ê°ê´€ì‹":
    # CSS: ë³´ê¸° ì„¸ë¡œ ë°°ì¹˜ ë° ì •ë ¬
    st.markdown(
        """<style>
        div[role='radiogroup'] > label {
            display: flex !important;
            align-items: center !important;
            margin-bottom: 0.5rem !important;
            margin-right: 0 !important;
        }
        div[role='radiogroup'] > label > div:first-child {
            margin-right: 0.5rem !important;
        }
        </style>""",
        unsafe_allow_html=True
    )

    # ë¬¸ì œ ë°©í–¥ ê²°ì • (í•œê¸€â†’ì˜ì–´ or ì˜ì–´â†’í•œê¸€)
    direction_key = f"direction_{st.session_state.quiz_index}"
    if direction_key not in st.session_state:
        st.session_state[direction_key] = random.choice(["kor_to_eng", "eng_to_kor"])
    direction = st.session_state[direction_key]

    # ì˜µì…˜ì„ ì„¸ì…˜ì— í•œ ë²ˆë§Œ ìƒì„±
    opt_key = f"opts_{st.session_state.quiz_index}"
    if opt_key not in st.session_state:
        if direction == "kor_to_eng":
            # í•œê¸€ ë¬¸ì œ â†’ ì˜ì–´ ì„ íƒì§€
            distractors = [
                d["ì˜ë‹¨ì–´"] for d in data
                if d["ì˜ë‹¨ì–´"].strip().lower() != q["ì˜ë‹¨ì–´"].strip().lower()
            ]
            opts = random.sample(distractors, min(3, len(distractors))) + [q["ì˜ë‹¨ì–´"]]
        else:
            # ì˜ì–´ ë¬¸ì œ â†’ í•œê¸€ ì„ íƒì§€
            distractors = [
                d["ëœ»"] for d in data
                if d["ëœ»"].strip().lower() != q["ëœ»"].strip().lower()
            ]
            opts = random.sample(distractors, min(3, len(distractors))) + [q["ëœ»"]]
        random.shuffle(opts)
        st.session_state[opt_key] = opts
    options = st.session_state[opt_key]

    # ë¬¸ì œ ì¶œì œ
    if direction == "kor_to_eng":
        question_text = f'"{q["ëœ»"]}"ì— í•´ë‹¹í•˜ëŠ” ì˜ì–´ ë‹¨ì–´ëŠ”?'
        correct_answer = q["ì˜ë‹¨ì–´"]
    else:
        question_text = f'"{q["ì˜ë‹¨ì–´"]}"ì˜ ëœ»ì€?'
        correct_answer = q["ëœ»"]

    # ë¼ë””ì˜¤ (key ì§€ì •)
    sel_key = f"sel_{st.session_state.quiz_index}"
    selected = st.radio(
        question_text,
        options,
        key=sel_key
    )

    # ì •ë‹µ í™•ì¸ ì „/í›„ì— ë”°ë¼ ë‹¤ë¥¸ UI í‘œì‹œ
    if not st.session_state.answered:
        # ì •ë‹µ í™•ì¸ ì „: ì •ë‹µ í™•ì¸í•˜ê¸° ë²„íŠ¼
        if st.button("ì •ë‹µ í™•ì¸í•˜ê¸°", key=f"check_btn_{st.session_state.quiz_index}"):
            is_corr = (selected.strip().lower() == correct_answer.strip().lower())
            st.session_state.all_answers.append({
                "word":        q["ì˜ë‹¨ì–´"],
                "meaning":     q["ëœ»"],
                "user_ans":    selected,
                "correct_ans": correct_answer,
                "is_correct":  is_corr
            })
            st.session_state.answered = True
            st.rerun()  # ì¦‰ì‹œ í™”ë©´ ê°±ì‹ 
    else:
        # ì •ë‹µ í™•ì¸ í›„: ê²°ê³¼ í‘œì‹œ + ë‹¤ìŒ ë¬¸ì œ í’€ê¸° ë²„íŠ¼
        last_answer = st.session_state.all_answers[-1]
        if last_answer["is_correct"]:
            st.success("âœ… ì •ë‹µì…ë‹ˆë‹¤!")
        else:
            st.error(f"âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: {correct_answer}")
        
        if st.button("â–¶ï¸ ë‹¤ìŒ ë¬¸ì œ í’€ê¸°", key=f"next_btn_{st.session_state.quiz_index}"):
            # ë‹¤ìŒ ë¬¸ì œ ì „ ì˜µì…˜/ì„ íƒ/ë¬¸ì œìœ í˜•/ë°©í–¥ ì‚­ì œ
            st.session_state.pop(opt_key, None)
            st.session_state.pop(sel_key, None)
            st.session_state.pop(direction_key, None)
            if st.session_state.quiz_type == "í˜¼í•©":
                st.session_state.pop(f"qtype_{st.session_state.quiz_index}", None)
            st.session_state.quiz_index += 1
            st.session_state.answered   = False
            st.rerun()  # ì¦‰ì‹œ í™”ë©´ ê°±ì‹ 

# â”€â”€â”€ 5.4.2) ì£¼ê´€ì‹ ë¬¸ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
elif q_type == "ì£¼ê´€ì‹":
    inp_key = f"input_{st.session_state.quiz_index}"
    ans     = st.text_input(
        f'"{q["ëœ»"]}"ì— í•´ë‹¹í•˜ëŠ” ì˜ì–´ ë‹¨ì–´ëŠ”?',
        key=inp_key
    )
    
    # ì •ë‹µ í™•ì¸ ì „/í›„ì— ë”°ë¼ ë‹¤ë¥¸ UI í‘œì‹œ
    if not st.session_state.answered:
        # ì •ë‹µ í™•ì¸ ì „: ì •ë‹µ í™•ì¸í•˜ê¸° ë²„íŠ¼
        if st.button("ì •ë‹µ í™•ì¸í•˜ê¸°", key=f"check_sa_btn_{st.session_state.quiz_index}"):
            is_corr = (ans.strip().lower() == q["ì˜ë‹¨ì–´"].strip().lower())
            st.session_state.all_answers.append({
                "word":        q["ì˜ë‹¨ì–´"],
                "meaning":     q["ëœ»"],
                "user_ans":    ans,
                "correct_ans": q["ì˜ë‹¨ì–´"],
                "is_correct":  is_corr
            })
            st.session_state.answered = True
            st.rerun()  # ì¦‰ì‹œ í™”ë©´ ê°±ì‹ 
    else:
        # ì •ë‹µ í™•ì¸ í›„: ê²°ê³¼ í‘œì‹œ + ë‹¤ìŒ ë¬¸ì œ í’€ê¸° ë²„íŠ¼
        last_answer = st.session_state.all_answers[-1]
        if last_answer["is_correct"]:
            st.success("âœ… ì •ë‹µì…ë‹ˆë‹¤!")
        else:
            st.error(f"âŒ ì˜¤ë‹µì…ë‹ˆë‹¤. ì •ë‹µ: {q['ì˜ë‹¨ì–´']}")
        
        if st.button("â–¶ï¸ ë‹¤ìŒ ë¬¸ì œ í’€ê¸°", key=f"next_sa_btn_{st.session_state.quiz_index}"):
            st.session_state.pop(inp_key, None)
            if st.session_state.quiz_type == "í˜¼í•©":
                st.session_state.pop(f"qtype_{st.session_state.quiz_index}", None)
            st.session_state.quiz_index += 1
            st.session_state.answered   = False
            st.rerun()  # ì¦‰ì‹œ í™”ë©´ ê°±ì‹ 
